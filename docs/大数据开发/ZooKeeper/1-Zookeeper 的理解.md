---

Created at: 2021-08-30
Last updated at: 2021-10-23


---

# 1-Zookeeper 的理解


zookeeper是一个中间件，ZooKeeper就干两件事：1.提供分布式存取数据的服务 2.通知正在监听的客户端

**1.****提供分布式存取数据的服务**
ZooKeeper是个存数据的地方，本质是上和MySQL、Redis一样：
ZooKeeper用树形结构来管理数据，树的节点可以有一个名字，节点里面还可以存储数据，不过数据量不能超过1M。这很有意思，一是节点的完整路径可以看作是key，节点里面存的数据可以看作是value，这就很像redis了，redis也是key-value，不过redis的key不是树形结构，没办法像zookeeper这样可以获取某一个节点下面的所有子节点，但是我们在使用redis时总是喜欢用树形结构来组织key（比如a::b，a::c，a::d）。二是因为可以获取某一个节点下面的所有子节点，所以在某些应用场景下，节点名字可以看作是key，它的所有子节点名字可以看作是value，此时的value就是一个集合（用节点的名字来存数据这种操作在平时使用windows文件也挺常用的，比如用txt文件的名字存提示信息）。总之一句话，zookeeper提供了一种这样的数据存取结构以及很方便的存取操作，但具体如何使用它就看你个人了。（有人把zookeeper的这种管理数据的方式称为文件系统，我个人觉得这样说非常具有误导性，虽然组织方式和文件系统一样，都是树结构构，并且面向的问题的本质也一样即数据的存取，但是，但是，zookeeper的树里直接存的就是数据，就像我们直接在代码里写的树一样，而文件系统里的树存的是文件的inode，inode指向文件，所以zookeeper的树和文件系统的树是非常不同的）。虽然zookeeper和redis在k-v这点上很像，但是它俩在功能和特性上还是很不一样，这也导致它们所解决的问题也很不一样。

zookeeper是分布式高可用的：
zookeeper的存储管理数据还有一个非常重要的功能，那就是它是分布式的，并且提供数据一致性的支持。因为zookeeper集群的每个主机都完整的保存着所有数据（即整棵树），所以所有主机上的数据的一致性就尤为重要了，客户端在某一个主机上的增删改操作需要立即同步到整个集群上。这点与redis集群的存储很不一样，redis集群是将数据均匀的散列到每一个redis主机上，每个redis主机并不保存所有的数据，只是保存数据的一部分，所以redis所需要解决的问题是数据散列分区均匀性的问题，而不是分布式集群中副本的一致性问题（当然redis的主从复制需要考虑一致性问题）。Zookeeper的这种每台主机均保持完整数据的副本的分布式存储策略的可用性比Redis更高点，不过在Redis集群中引入主从复制之后，两种分布式存储策略的可用性也差不多。
而对于HDFS分布式文件系统而言，并不需要考虑数据的一致性问题，因为它并不支持文件随机修改，并且所有对文件元数据的增删都只在namenode上进行，而且还有最重要的一点是，zookeeper的读取是可以在集群内任意一个主机上进行的，因为每个主机都保存着完整的副本，但从HDFS中读取文件需要经过namenode。所以总结一点就是，因为zookeeper的每个节点都完整地保存着数据的副本，并且读取操作可以在任何一个节点上进行，所以需要保证写数据的分布式一致性，这里数据的一致性与事务的一致性还有点区别，这里说的数据的一致性指的是副本的数据相同，而事务的一致性指的是数据在事务执行前后在逻辑上是一致的。

综上，zookeeper存储管理数据有两个特点，一是能作为数据存储的中间件，二是可以分布式存储。
第一个特点，作为数据存储的中间件，zookeeper没有像redis那样强悍的功能，不能用来存储大规模数据，zookeeper的每个节点Znode只能用来存储少量的状态和配置信息，每个节点的数据最大不能超过1MB，所以zookeeper与redis解决的问题不同，zookeeper只能提供一些简单数据存取服务，比如：配置中心，注册中心。但说的是中心，其实并不是真的像nacos那样是真的中心，zookeeper是分布式的，有着更高的可用性（这里要重点区分一下可靠性和可用性，可靠性一般是指数据存储的可靠性，比如将数据存在磁盘上就比存在内存上可靠，分布的存在多台机器上就比存在单台机器上可靠；而可用性则指的是系统或者说服务的可用性，启用多台主机提供服务就比单台具有更高的可用性）。还有就是统一命名服务，也就是可以把一些需要映射的东西存在zookeeper中，比如服务名与ip地址的映射（这好像又回到了注册中心）。
第二个特点，分布式存储，这一点提供的就是更高的可靠性和可用性。

（题外话，RPC为什么需要注册中心，没有注册中心就不能RPC了吗？当然不是，没有注册中心一样可以RPC，只不过这样RPC的调用就写死了，不过灵活，加一层注册中心就可以系统解耦了，因为这样服务可以由多台不同的主机提供，从而可以动态的上下线主机）

**2.通知正在监听的客户端**
这点和消息队列很像——发布订阅模式，但是也有差别，发布订阅的消息中间件的消费者是主动轮询队列中有没有数据，而zookeeper是主动通知正在监听的客户端。当节点上数据发生变化时，zookeeper会通知正在监听此节点的客户端，zookeeper的许多应用正是基于这一点，比如还是配置中心，当配置发生变化时可以及时通知客户端；还可以统一管理集群，管理服务器的动态上下线。

**为什么说zookeeper是分布式协调系统？**两个问题：一是分布式集群有哪些问题需要协调？二是zookeeper如何在进行协调？

集群中的每一台主机 **对于集群所共享（读）和共同管理（写）的一些元数据信息** 是需要具有一致性的，比如Kafka集群的topic信息。对此的解决方案有两种，一是使用一个单点数据库来存储数据，如MySQL和Redis，但对于分布式集群来说，其它组件都是分布式高可用的了，就数据存取服务不是分布式高可用，存在着单点故障，那么整个集群也就不能算是分布式高可用的；二是集群自己解决数据在每台主机的同步问题，也就是说，Kafka集群需要自己写一套数据同步的代码，HBase也需要自己实现一套数据同步，这无疑就是在重复实现具有相同功能的轮子。但其实集群需要的无非就是一个分布式高可用的数据存取服务，而且这个数据的数据量也并不大，只是一些元数据信息，并不需要MySQL和Redis提供的大量数据的快速存取服务，对于这个需求，zookeeper就诞生了，zookeeper是分布式高可用的，并且数据在zookeeper集群中能做到一致性，所以zookeeper解决了分布式集群的数据协调问题。
对于一个集群来说，有些事情是只需要也只能由一个主机来完成的，比如将任务分配给集群中的主机（如为Kafka选举controller，为HBase的HMaster集群选举主HMaster），所以我们需要为集群选出一个Leader，这就可以用到zookeeper的节点创建来完成，因为节点只能被创建一次，所以可以将节点创建成功的主机作为Leader。
对于一个集群来说，主机的动态上线需要通知给集群中的其它主机，这样集群就能动态的调整任务，这时就可以利用zookeeper提供的通知监听服务来完成，每一个上线主机在zookeeper中创建一个临时节点，其它主机都负责监听，当有主机下线时，其它主机就会收到zookeeper的通知。

对于这两个问题：一是分布式集群有哪些问题需要协调？二是zookeeper如何在进行协调？
分布式集群中的数据和主机上下线需要协调，通过zookeeper的分布式存取数据和通知监听机制就能完成协调。

